<!DOCTYPE html> 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link id="favicon" rel="icon" type="image/svg+xml" href="">
    <title>Fruit Ninja - Arvione AI</title>
    <!-- ÂºïÂÖ• MediaPipe Hands Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }

        /* ÈöêËóèÂéüÂßãËßÜÈ¢ëÊµÅÔºåÊàë‰ª¨Âú® Canvas ‰∏äÁªòÂà∂ */
        #input_video {
            display: none;
        }

        /* UI Ë¶ÜÁõñÂ±Ç */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: clamp(20px, 5vw, 32px);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
        }

        #score,
        #timer {
            font-family: 'Courier New', Courier, monospace;
            line-height: 1;
        }

        #timer {
            color: #ffeb3b;
        }

        #loading,
        #start-screen,
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            pointer-events: auto;
        }

        #damage-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: red;
            opacity: 0;
            z-index: 5;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        h1 {
            font-size: clamp(32px, 8vw, 48px);
            margin-bottom: 10px;
            color: #ffeb3b;
        }

        p {
            font-size: clamp(14px, 3.5vw, 18px);
            color: #ccc;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.5;
            padding: 0 20px;
        }

        .btn {
            padding: 12px 30px;
            font-size: clamp(18px, 4vw, 24px);
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
            transition: transform 0.2s;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        #cam-preview {
            position: absolute;
            top: 60px;
            left: 20px;
            width: clamp(100px, 25vw, 160px);
            height: clamp(75px, 18.75vw, 120px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            z-index: 5;
            opacity: 0.6;
            transform: scaleX(-1);
        }

        .float-score {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            color: white;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        /* ËØ≠Ë®ÄÂàáÊç¢ËèúÂçï */
        #lang-selector {
            position: absolute;
            top: 60px;
            right: 20px;
            z-index: 25;
            pointer-events: auto;
        }

        #lang-toggle {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            -webkit-tap-highlight-color: transparent;
        }

        #lang-toggle:hover {
            background: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.5);
        }

        #lang-menu {
            position: absolute;
            top: 45px;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 110px;
            backdrop-filter: blur(10px);
        }

        #lang-menu.show {
            display: flex;
        }

        .lang-btn {
            padding: 8px 15px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: clamp(12px, 3vw, 14px);
            transition: all 0.3s;
            text-align: left;
            -webkit-tap-highlight-color: transparent;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang-btn.active {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        .lang-icon {
            font-size: clamp(14px, 3.5vw, 18px);
        }

        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .hud {
                padding: 10px 15px;
            }

            #lang-selector {
                top: 50px;
                right: 15px;
            }

            #cam-preview {
                top: 50px;
                left: 15px;
            }

            h1 {
                margin-bottom: 5px;
            }

            p {
                margin-bottom: 20px;
                padding: 0 15px;
            }
        }

        @media (max-width: 480px) {
            .hud {
                padding: 8px 10px;
            }

            #cam-preview {
                width: 80px;
                height: 60px;
            }

            #lang-toggle {
                padding: 6px 12px;
                gap: 4px;
            }

            #lang-menu {
                min-width: 100px;
                top: 40px;
            }
        }

        /* Ê®™Â±èÊ®°Âºè‰ºòÂåñ */
        @media (orientation: landscape) and (max-height: 500px) {
            .hud {
                padding: 5px 15px;
                font-size: clamp(16px, 3vw, 24px);
            }

            #cam-preview {
                width: 100px;
                height: 75px;
                top: 40px;
            }

            #lang-selector {
                top: 40px;
            }

            h1 {
                font-size: clamp(24px, 6vw, 36px);
            }

            p {
                font-size: clamp(12px, 2.5vw, 14px);
                margin-bottom: 15px;
            }

            .btn {
                padding: 8px 20px;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
        <div id="damage-overlay"></div>

        <canvas id="cam-preview"></canvas>

        <!-- ËØ≠Ë®ÄÂàáÊç¢ËèúÂçï -->
        <div id="lang-selector">
            <div id="lang-toggle" onclick="toggleLangMenu()">
                <span class="lang-icon">üåê</span>
                <span id="current-lang">EN</span>
                <span style="font-size: 12px;">‚ñº</span>
            </div>
            <div id="lang-menu">
                <button class="lang-btn active" onclick="changeLanguage('en')">üá¨üáß English</button>
                <button class="lang-btn" onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</button>
                <button class="lang-btn" onclick="changeLanguage('ja')">üáØüáµ Êó•Êú¨Ë™û</button>
            </div>
        </div>

        <div id="ui-layer">
            <div class="hud">
                <div id="score">Score: 0</div>
                <div id="timer">03:00</div>
            </div>
            <div id="floating-scores"
                style="position: absolute; top:0; left:0; width:100%; height:100%; overflow:hidden;"></div>
        </div>

        <div id="loading">
            <h1 id="loading-title">Starting AI Model...</h1>
            <p id="loading-text">Please allow camera permission for gesture recognition</p>
            <div class="loader" style="font-size: 30px;">‚åõ</div>
        </div>

        <div id="start-screen" class="hidden">
            <h1 id="game-title">Gesture Fruit Slicer</h1>
            <p id="game-instructions">
                <b id="mode-text">Timed Mode (3 minutes)</b><br>
                <span id="instruction-1">Raise your index finger as the blade.</span><br>
                <span id="instruction-2">Slice fruits to score, bombs (üí£) deduct points!</span><br>
                <span id="instruction-3">Missing fruits won't deduct health.</span>
            </p>
            <button class="btn" id="start-btn" onclick="startGame()">Start Game</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <h1 id="gameover-title">Time's Up!</h1>
            <p id="final-score" style="font-size: 36px; color: #fff;">Score: 0</p>
            <button class="btn" id="restart-btn" onclick="startGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Update favicon
        function updateFavicon(emoji) {
            const favicon = document.getElementById('favicon');
            // Use TextEncoder to handle Unicode characters properly
            const encoder = new TextEncoder();
            const data = encoder.encode(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32"><text y="24" font-size="24" font-family="Arial, sans-serif">${emoji}</text></svg>`);
            const base64 = btoa(String.fromCharCode(...data));
            favicon.href = `data:image/svg+xml;base64,${base64}`;
        }

        // --- Â§öËØ≠Ë®ÄÊñáÊú¨ ---
        const translations = {
            en: {
                score: "Score",
                loadingTitle: "Starting AI Model...",
                loadingText: "Please allow camera permission for gesture recognition",
                gameTitle: "Gesture Fruit Slicer",
                modeText: "Timed Mode (3 minutes)",
                instruction1: "Raise your index finger as the blade.",
                instruction2: "Slice fruits to score, bombs (üí£) deduct points!",
                instruction3: "Missing fruits won't deduct health.",
                startBtn: "Start Game",
                gameoverTitle: "Time's Up!",
                finalScore: "Final Score",
                restartBtn: "Play Again"
            },
            zh: {
                score: "ÂæóÂàÜ",
                loadingTitle: "Ê≠£Âú®ÂêØÂä® AI Ê®°Âûã...",
                loadingText: "ËØ∑ÂÖÅËÆ∏ÊëÑÂÉèÂ§¥ÊùÉÈôê‰ª•ËøõË°åÊâãÂäøËØÜÂà´",
                gameTitle: "ÊâãÂäøÂàáÊ∞¥Êûú",
                modeText: "ÈôêÊó∂Ê®°Âºè (3ÂàÜÈíü)",
                instruction1: "‰∏æËµ∑È£üÊåá‰Ωú‰∏∫ÂàÄÂàÉ„ÄÇ",
                instruction2: "ÂàáÁ¢éÊ∞¥ÊûúÂæóÂàÜÔºåÁÇ∏Âºπ(üí£)‰ºöÊâ£ÂàÜÔºÅ",
                instruction3: "ÊºèÊéâÊ∞¥Êûú‰∏ç‰ºöÊâ£Ë°Ä„ÄÇ",
                startBtn: "ÂºÄÂßãËÆ°Êó∂",
                gameoverTitle: "Êó∂Èó¥Âà∞ÔºÅ",
                finalScore: "ÊúÄÁªàÂæóÂàÜ",
                restartBtn: "ÂÜçÊù•‰∏ÄÂ±Ä"
            },
            ja: {
                score: "„Çπ„Ç≥„Ç¢",
                loadingTitle: "AI„É¢„Éá„É´„ÇíËµ∑Âãï‰∏≠...",
                loadingText: "„Ç∏„Çß„Çπ„ÉÅ„É£„ÉºË™çË≠ò„ÅÆ„Åü„ÇÅ„Å´„Ç´„É°„É©„ÅÆË®±ÂèØ„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                gameTitle: "„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Éï„É´„Éº„ÉÑ„Çπ„É©„Ç§„Çµ„Éº",
                modeText: "„Çø„Ç§„É†„É¢„Éº„Éâ (3ÂàÜÈñì)",
                instruction1: "‰∫∫Â∑Æ„ÅóÊåá„ÇíÂàÉ„Å®„Åó„Å¶‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                instruction2: "„Éï„É´„Éº„ÉÑ„ÇíÂàá„Çã„Å®ÂæóÁÇπ„ÄÅÁàÜÂºæ(üí£)„ÅØÊ∏õÁÇπÔºÅ",
                instruction3: "„Éï„É´„Éº„ÉÑ„ÇíÈÄÉ„Åó„Å¶„ÇÇ„ÉÄ„É°„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
                startBtn: "„Ç≤„Éº„É†ÈñãÂßã",
                gameoverTitle: "„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ",
                finalScore: "ÊúÄÁµÇ„Çπ„Ç≥„Ç¢",
                restartBtn: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶"
            }
        };

        let currentLang = 'en';

        function toggleLangMenu() {
            const menu = document.getElementById('lang-menu');
            menu.classList.toggle('show');
        }

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('lang-selector');
            const menu = document.getElementById('lang-menu');
            if (selector && !selector.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            // Êõ¥Êñ∞ÂΩìÂâçËØ≠Ë®ÄÊòæÁ§∫
            const langNames = { en: 'EN', zh: '‰∏≠Êñá', ja: 'Êó•Êú¨Ë™û' };
            document.getElementById('current-lang').innerText = langNames[lang];
            
            // Êõ¥Êñ∞ÊâÄÊúâÊñáÊú¨
            document.getElementById('score').innerText = `${t.score}: ${score}`;
            document.getElementById('loading-title').innerText = t.loadingTitle;
            document.getElementById('loading-text').innerText = t.loadingText;
            document.getElementById('game-title').innerText = t.gameTitle;
            document.getElementById('mode-text').innerText = t.modeText;
            document.getElementById('instruction-1').innerText = t.instruction1;
            document.getElementById('instruction-2').innerText = t.instruction2;
            document.getElementById('instruction-3').innerText = t.instruction3;
            document.getElementById('start-btn').innerText = t.startBtn;
            document.getElementById('gameover-title').innerText = t.gameoverTitle;
            document.getElementById('restart-btn').innerText = t.restartBtn;
            
            // Êõ¥Êñ∞ÊúÄÁªàÂàÜÊï∞ÊòæÁ§∫
            if (gameState === 'gameover') {
                document.getElementById('final-score').innerText = `${t.finalScore}: ${score}`;
            }

            // Êõ¥Êñ∞ËØ≠Ë®ÄÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ÂÖ≥Èó≠ËèúÂçï
            document.getElementById('lang-menu').classList.remove('show');
        }

        // --- Ê∏∏ÊàèÈÖçÁΩÆ‰∏éÁä∂ÊÄÅ ---
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('cam-preview');
        const previewCtx = previewCanvas.getContext('2d');
        const videoElement = document.getElementById('input_video');
        const damageOverlay = document.getElementById('damage-overlay');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameState = 'loading';
        let score = 0;

        const GAME_DURATION = 180;
        let timeLeft = GAME_DURATION;
        let lastTime = 0;
        let timerInterval = null;

        const blade = {
            points: [],
            maxLength: 10,
            color: '#00ffff',
            x: 0,
            y: 0,
            isActive: false
        };

        let fruits = [];
        let particles = [];

        const GRAVITY = 0.2;
        const SPAWN_RATE = 50;
        let frameCount = 0;

        const FRUIT_TYPES = [
            { type: 'apple', icon: 'üçé', score: 10, color: '#ff0000' },
            { type: 'banana', icon: 'üçå', score: 10, color: '#ffe135' },
            { type: 'watermelon', icon: 'üçâ', score: 20, color: '#ff6b6b' },
            { type: 'orange', icon: 'üçä', score: 10, color: '#ffa500' },
            { type: 'grape', icon: 'üçá', score: 15, color: '#8b00ff' },
            { type: 'pineapple', icon: 'üçç', score: 30, color: '#ffdd00' },
            { type: 'bomb', icon: 'üí£', score: -50, color: '#000000' }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'slice') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'bomb') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.5);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        function triggerDamageEffect() {
            damageOverlay.style.opacity = '0.5';
            setTimeout(() => {
                damageOverlay.style.opacity = '0';
            }, 200);
        }

        function showFloatingText(text, x, y, color) {
            const div = document.createElement('div');
            div.className = 'float-score';
            div.innerText = text;
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            div.style.color = color;
            document.getElementById('floating-scores').appendChild(div);

            setTimeout(() => {
                div.remove();
            }, 1000);
        }

        class Fruit {
            constructor() {
                this.radius = 40;
                this.x = Math.random() * (canvas.width - 100) + 50;
                this.y = canvas.height + this.radius;

                this.vx = (Math.random() - 0.5) * 5;
                this.vy = -(Math.random() * 6 + 11);

                const isBomb = Math.random() < 0.15;
                const typeData = isBomb ? FRUIT_TYPES.find(t => t.type === 'bomb') : FRUIT_TYPES[Math.floor(Math.random() * (FRUIT_TYPES.length - 1))];

                this.icon = typeData.icon;
                this.type = typeData.type;
                this.scoreVal = typeData.score;
                this.color = typeData.color;

                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                this.sliced = false;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += GRAVITY;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.font = "60px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.icon, 0, 5);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = Math.random() * 5 + 2;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.01;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += GRAVITY * 0.5;
                this.life -= this.decay;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function checkCollisions() {
            if (!blade.isActive) return;

            const fingerX = blade.x;
            const fingerY = blade.y;

            for (let i = fruits.length - 1; i >= 0; i--) {
                const f = fruits[i];
                if (f.sliced) continue;

                const dx = fingerX - f.x;
                const dy = fingerY - f.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < f.radius) {
                    if (f.type === 'bomb') {
                        score += f.scoreVal;
                        showFloatingText("-50", f.x, f.y, "red");
                        triggerDamageEffect();
                        playSound('bomb');
                        createExplosion(f.x, f.y, "#333");
                        fruits.splice(i, 1);
                    } else {
                        f.sliced = true;
                        score += f.scoreVal;
                        showFloatingText("+" + f.scoreVal, f.x, f.y, "#fff");
                        createExplosion(f.x, f.y, f.color);
                        playSound('slice');
                        fruits.splice(i, 1);
                    }
                    updateUI();
                }
            }
        }

        function gameUpdate() {
            if (gameState !== 'playing') return;

            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            timeLeft -= dt;
            if (timeLeft <= 0) {
                timeLeft = 0;
                updateUI();
                gameOver();
                return;
            }

            updateUI();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (blade.points.length > 1) {
                ctx.beginPath();
                ctx.moveTo(blade.points[0].x, blade.points[0].y);
                for (let i = 1; i < blade.points.length - 1; i++) {
                    const xc = (blade.points[i].x + blade.points[i + 1].x) / 2;
                    const yc = (blade.points[i].y + blade.points[i + 1].y) / 2;
                    ctx.quadraticCurveTo(blade.points[i].x, blade.points[i].y, xc, yc);
                }
                ctx.lineCap = 'round';
                ctx.lineWidth = 8;
                ctx.strokeStyle = '#00ffff';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#00ffff';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            frameCount++;
            if (frameCount % SPAWN_RATE === 0) {
                fruits.push(new Fruit());
            }

            for (let i = fruits.length - 1; i >= 0; i--) {
                let f = fruits[i];
                f.update();
                f.draw();

                if (f.y > canvas.height + 100) {
                    fruits.splice(i, 1);
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            checkCollisions();

            requestAnimationFrame(gameUpdate);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateUI() {
            const t = translations[currentLang];
            document.getElementById('score').innerText = `${t.score}: ${score}`;
            document.getElementById('timer').innerText = formatTime(timeLeft);

            if (timeLeft < 10) {
                document.getElementById('timer').style.color = '#ff4b2b';
            } else {
                document.getElementById('timer').style.color = '#ffeb3b';
            }
        }

        function startGame() {
            score = 0;
            timeLeft = GAME_DURATION;
            fruits = [];
            particles = [];
            frameCount = 0;
            lastTime = Date.now();
            document.getElementById('floating-scores').innerHTML = '';

            updateUI();

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            gameState = 'playing';
            gameUpdate();
        }

        function gameOver() {
            gameState = 'gameover';
            const t = translations[currentLang];
            document.getElementById('final-score').innerText = `${t.finalScore}: ${score}`;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        function onResults(results) {
            previewCanvas.width = 160;
            previewCanvas.height = 120;
            previewCtx.save();
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(results.image, 0, 0, previewCanvas.width, previewCanvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const indexFingerTip = landmarks[8];

                const x = (1.0 - indexFingerTip.x) * canvas.width;
                const y = indexFingerTip.y * canvas.height;

                blade.x = x;
                blade.y = y;
                blade.isActive = true;

                blade.points.push({ x, y });
                if (blade.points.length > blade.maxLength) {
                    blade.points.shift();
                }

                const px = (1.0 - indexFingerTip.x) * previewCanvas.width;
                const py = indexFingerTip.y * previewCanvas.height;
                previewCtx.beginPath();
                previewCtx.arc(px, py, 5, 0, 2 * Math.PI);
                previewCtx.fillStyle = "#00ffff";
                previewCtx.fill();

            } else {
                blade.isActive = false;
                if (blade.points.length > 0) blade.points.shift();
            }
            previewCtx.restore();

            if (document.getElementById('loading').style.display !== 'none') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-screen').classList.remove('hidden');
                gameState = 'menu';
            }
        }

        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({ image: videoElement });
            },
            width: 640,
            height: 480
        });

        camera.start();

        updateFavicon('ü¶ä');

        window.addEventListener('resize', () => {
            resizeCanvas();
        });

        // Èò≤Ê≠¢ÁßªÂä®Á´ØÂèåÂáªÁº©Êîæ
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Èò≤Ê≠¢ÁßªÂä®Á´Ø‰∏ãÊãâÂà∑Êñ∞
        document.body.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

    </script>
</body>

</html>